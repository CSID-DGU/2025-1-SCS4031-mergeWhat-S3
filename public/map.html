<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script
        src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=d73e9b362b7e9d719a4bf602da77dcb4&libraries=services&autoload=false">
        </script>
    <style>
        html,
        body,
        #map {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
        }

        .marker-label {
            position: relative;
            left: 50%;
            top: 20px;
            transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.8);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            color: #333;
            white-space: nowrap;
            pointer-events: none;
        }

        .parking-label {
            background: rgba(255, 255, 255, 0.9);
            padding: 4px 8px;
            border-radius: 6px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
            font-size: 12px;
            line-height: 1.2;
            text-align: center;
            pointer-events: none;
            margin-bottom: 40px;
        }

        .parking-label strong {
            display: block;
            font-size: 13px;
            margin-bottom: 2px;
        }
    </style>
</head>

<body>
    <div id="map"></div>
    <script>
        // console.log → RN
        (function () {
            const orig = console.log;
            console.log = (...args) => {
                window.ReactNativeWebView.postMessage(
                    JSON.stringify({ type: 'CONSOLE', payload: ['[HTML]', ...args] })
                );
                orig.apply(console, args);
            };
        })();

        kakao.maps.load(function () {
            const map = new kakao.maps.Map(
                document.getElementById('map'),
                { center: new kakao.maps.LatLng(37.55893664, 126.9987376), level: 3 }
            );
            const placesService = new kakao.maps.services.Places(map);

            let lastPlaces = [];
            let markers = [], overlays = [];
            let parkingMarkers = [], parkingOverlays = [];

            function clearAll() {
                markers.forEach(m => m.setMap(null)); markers = [];
                overlays.forEach(o => o.setMap(null)); overlays = [];
                parkingMarkers.forEach(m => m.setMap(null)); parkingMarkers = [];
                parkingOverlays.forEach(o => o.setMap(null)); parkingOverlays = [];
            }

            window.searchPlaces = function (keyword) {
                clearAll();
                const center = map.getCenter();
                placesService.keywordSearch(keyword, (data, status) => {
                    if (status === kakao.maps.services.Status.OK && data.length) {
                        lastPlaces = data.map(p => ({ name: p.place_name, lat: +p.y, lng: +p.x }));
                        const bounds = new kakao.maps.LatLngBounds();
                        data.forEach((p, i) => {
                            const pos = new kakao.maps.LatLng(p.y, p.x);
                            const m = new kakao.maps.Marker({ position: pos, map });
                            markers.push(m);
                            kakao.maps.event.addListener(m, 'click', () => {
                                window.ReactNativeWebView.postMessage(
                                    JSON.stringify({ type: 'MARKER_CLICK', index: i })
                                );
                            });
                            const ov = new kakao.maps.CustomOverlay({
                                map, position: pos,
                                content: `<div class="marker-label">${p.place_name}</div>`,
                                yAnchor: 1, offset: new kakao.maps.Size(0, 15)
                            });
                            overlays.push(ov);
                            bounds.extend(pos);
                        });
                        map.setBounds(bounds);
                        window.ReactNativeWebView.postMessage(
                            JSON.stringify({ type: 'PLACES_LIST', places: lastPlaces.map(p => p.name) })
                        );
                    }
                }, { location: center, radius: 2000 });
            };

            window.searchParking = async function () {
                clearAll();
                const key = '4d5054615477686d373350634c6477';

                // 1) 메타 데이터 전체 로드
                const metaResp = await fetch(
                    `http://openapi.seoul.go.kr:8088/${key}/json/GetParkInfo/1/1000/종로구`
                );
                const metaJson = await metaResp.json();
                const meta = metaJson.GetParkInfo?.row || [];
                console.log('▶️ [DEBUG-meta] first row keys:', Object.keys(meta[0]), meta[0]);
                console.log('▶️ [DEBUG] meta rows:', meta);

                // 2) 실시간 현황 전체 로드
                const realResp = await fetch(
                    `http://openapi.seoul.go.kr:8088/${key}/json/GetParkingInfo/1/1000/종로구`
                );
                const realJson = await realResp.json();
                const real = realJson.GetParkingInfo?.row || [];
                console.log('▶️ [DEBUG] real rows:', real);

                // 3) 실시간 현황에서 사용 중 카운트만 추출
                const realMap = {};
                real.forEach(r => {
                    console.log(`[DEBUG-real] PKLT_CD=${r.PKLT_CD}, PKLT_NM="${r.PKLT_NM}", NOW_PRK_VHCL_CNT=${r.NOW_PRK_VHCL_CNT}`);
                    realMap[r.PKLT_CD] = Number(r.NOW_PRK_VHCL_CNT) || 0;
                });

                const bounds = map.getBounds();
                const seen = new Set();
                const list = [];

                // 4) 메타 기준으로 지도에 뿌릴 데이터 구성
                meta.forEach(item => {
                    const code = item.PKLT_CD;
                    if (seen.has(code)) return;
                    seen.add(code);

                    const lat = parseFloat(item.LAT), lng = parseFloat(item.LOT);
                    if (isNaN(lat) || isNaN(lng)) return;
                    const pos = new kakao.maps.LatLng(lat, lng);
                    if (!bounds.contain(pos)) return;

                    const total = Number(item.TPKCT) || 0;
                    const used = realMap[code] || 0;
                    const free = total - used;
                    console.log(`[DEBUG-meta] PKLT_CD=${code}, total=${total}, used=${used}, free=${free}`);

                    list.push({
                        name: item.PKLT_NM,
                        lat, lng,
                        info: { free, total }
                    });
                });

                lastPlaces = list;

                // 5) 지도에 표시
                list.forEach((p, i) => {
                    const pos = new kakao.maps.LatLng(p.lat, p.lng);
                    const m = new kakao.maps.Marker({ position: pos, map });
                    parkingMarkers.push(m);
                    kakao.maps.event.addListener(m, 'click', () => {
                        window.ReactNativeWebView.postMessage(
                            JSON.stringify({ type: 'MARKER_CLICK', index: i })
                        );
                    });
                    const content = p.info.total
                        ? `<div class="parking-label">
                             <strong>${p.name}</strong>
                             ${p.info.free}/${p.info.total}
                           </div>`
                        : `<div class="marker-label">${p.name}</div>`;
                    const ov = new kakao.maps.CustomOverlay({
                        map, position: pos,
                        content, yAnchor: 1,
                        offset: new kakao.maps.Size(0, 15)
                    });
                    parkingOverlays.push(ov);
                });

                window.ReactNativeWebView.postMessage(
                    JSON.stringify({ type: 'PLACES_LIST', places: list.map(p => p.name) })
                );
            };

            window.selectPlace = function (idx) {
                clearAll();
                const p = lastPlaces[idx];
                if (!p) return;
                const pos = new kakao.maps.LatLng(p.lat, p.lng);
                const m = new kakao.maps.Marker({ position: pos, map });
                markers.push(m);
                const ov = new kakao.maps.CustomOverlay({
                    map, position: pos,
                    content: `<div class="marker-label">${p.name}</div>`,
                    yAnchor: 1, offset: new kakao.maps.Size(0, 15)
                });
                overlays.push(ov);
                map.setCenter(pos);
                map.setLevel(4);
            };

            function handleMessage(e) {
                let msg;
                try { msg = JSON.parse(e.data) } catch { return }
                if (msg.keyword) window.searchPlaces(msg.keyword);
                else if (msg.type === 'PARKING') window.searchParking();
                else if (msg.index !== undefined) window.selectPlace(msg.index);
            }
            window.addEventListener('message', handleMessage);
            document.addEventListener('message', handleMessage);
        });
    </script>
</body>

</html>