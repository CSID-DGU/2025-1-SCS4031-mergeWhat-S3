<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script
        src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=d73e9b362b7e9d719a4bf602da77dcb4&libraries=services&autoload=false">
        </script>
    <style>
        html,
        body,
        #map {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
        }

        .marker-label {
            position: relative;
            left: 50%;
            top: 20px;
            transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.8);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            color: #333;
            white-space: nowrap;
            pointer-events: none;
        }

        .parking-label {
            background: rgba(255, 255, 255, 0.9);
            padding: 4px 8px;
            border-radius: 6px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
            font-size: 12px;
            line-height: 1.2;
            text-align: center;
            pointer-events: none;
            margin-bottom: 40px;
            pointer-events: none;
        }

        .parking-label strong {
            display: block;
            font-size: 13px;
            margin-bottom: 2px;
        }
    </style>
</head>

<body>
    <div id="map"></div>
    <script>
        // console.log → ReactNativeWebView
        (function () {
            const orig = console.log;
            console.log = (...args) => {
                window.ReactNativeWebView.postMessage(
                    JSON.stringify({ type: 'CONSOLE', payload: ['[HTML]', ...args] })
                );
                orig.apply(console, args);
            };
        })();

        kakao.maps.load(function () {
            const map = new kakao.maps.Map(
                document.getElementById('map'),
                { center: new kakao.maps.LatLng(37.55893664, 126.9987376), level: 3 }
            );
            const placesService = new kakao.maps.services.Places(map);

            let lastPlaces = [];
            let markers = [], overlays = [];
            let parkingMarkers = [], parkingOverlays = [];

            function clearAll() {
                markers.forEach(m => m.setMap(null)); markers = [];
                overlays.forEach(o => o.setMap(null)); overlays = [];
                parkingMarkers.forEach(m => m.setMap(null)); parkingMarkers = [];
                parkingOverlays.forEach(o => o.setMap(null)); parkingOverlays = [];
            }

            window.searchPlaces = function (keyword) {
                clearAll();
                const center = map.getCenter();
                placesService.keywordSearch(keyword, (data, status) => {
                    if (status === kakao.maps.services.Status.OK && data.length) {
                        lastPlaces = data.map(p => ({ name: p.place_name, lat: +p.y, lng: +p.x }));
                        const bounds = new kakao.maps.LatLngBounds();
                        data.forEach((p, i) => {
                            const pos = new kakao.maps.LatLng(p.y, p.x);
                            const m = new kakao.maps.Marker({ position: pos, map, zIndex: 10 });
                            markers.push(m);
                            kakao.maps.event.addListener(m, 'click', () => {
                                window.ReactNativeWebView.postMessage(
                                    JSON.stringify({ type: 'MARKER_CLICK', name: p.place_name })
                                );
                            });
                            const ov = new kakao.maps.CustomOverlay({
                                map, position: pos,
                                content: `<div class="marker-label">${p.place_name}</div>`,
                                yAnchor: 1, offset: new kakao.maps.Size(0, 15)
                            });
                            overlays.push(ov);
                            bounds.extend(pos);
                        });
                        map.setBounds(bounds);
                        window.ReactNativeWebView.postMessage(
                            JSON.stringify({ type: 'PLACES_LIST', places: lastPlaces.map(p => p.name) })
                        );
                    }
                }, { location: center, radius: 2000 });
            };

            window.searchParking = async function () {
                clearAll();

                const key = '4d5054615477686d373350634c6477';

                const metaResp = await fetch(`http://openapi.seoul.go.kr:8088/${key}/json/GetParkInfo/1/1000/`);
                const metaJson = await metaResp.json();
                const meta = metaJson.GetParkInfo?.row || [];

                const realResp = await fetch(`http://openapi.seoul.go.kr:8088/${key}/json/GetParkingInfo/1/1000/`);
                const realJson = await realResp.json();
                const real = realJson.GetParkingInfo?.row || [];

                const realMap = {};
                real.forEach(r => {
                    realMap[r.PKLT_CD] = Number(r.NOW_PRK_VHCL_CNT) || 0;
                });

                const bounds = map.getBounds();
                const sw = bounds.getSouthWest();
                const ne = bounds.getNorthEast();
                const paddingLat = 0.005;
                const paddingLng = 0.005;
                const extendedBounds = new kakao.maps.LatLngBounds(
                    new kakao.maps.LatLng(sw.getLat() - paddingLat, sw.getLng() - paddingLng),
                    new kakao.maps.LatLng(ne.getLat() + paddingLat, ne.getLng() + paddingLng)
                );

                // 이름 기준 그룹핑
                const groups = {};
                meta.forEach(item => {
                    const name = item.PKLT_NM;
                    if (!groups[name]) groups[name] = [];
                    groups[name].push(item);
                });

                // 중복 사용 방지용 Set
                const usedSet = new Set();

                const list = Object.entries(groups).map(([name, items]) => {
                    const total = items.reduce((sum, it) => sum + (Number(it.TPKCT) || 0), 0);

                    const used = items.reduce((sum, it) => {
                        const code = it.PKLT_CD;
                        if (usedSet.has(code)) return sum;
                        usedSet.add(code);
                        return sum + (realMap[code] || 0);
                    }, 0);

                    const lat = parseFloat(items[0].LAT);
                    const lng = parseFloat(items[0].LOT);
                    return { name, lat, lng, info: { free: total - used, total } };
                }).filter(p =>
                    extendedBounds.contain(new kakao.maps.LatLng(p.lat, p.lng))
                );

                lastPlaces = list;

                list.forEach((p, i) => {
                    const pos = new kakao.maps.LatLng(p.lat, p.lng);
                    const m = new kakao.maps.Marker({ position: pos, map, zIndex: 10 });
                    markers.push(m);
                    kakao.maps.event.addListener(m, 'click', () => {
                        window.ReactNativeWebView.postMessage(
                            JSON.stringify({ type: 'MARKER_CLICK', index: i, name: p.name })
                        );
                    });

                    const free = Math.max(p.info.free, 0);
                    const content = p.info.total
                        ? `<div class="parking-label"><strong>${p.name}</strong>${free}/${p.info.total}</div>`
                        : `<div class="marker-label">${p.name}</div>`;
                    const ov = new kakao.maps.CustomOverlay({
                        map, position: pos,
                        content, yAnchor: 1,
                        offset: new kakao.maps.Size(0, 15)
                    });
                    overlays.push(ov);
                });

                window.ReactNativeWebView.postMessage(
                    JSON.stringify({
                        type: 'PARKING_DATA',
                        data: list.reduce((acc, p) => {
                            acc[p.name] = {
                                free: p.info.free,
                                total: p.info.total,
                                lat: p.lat,
                                lng: p.lng
                            };
                            return acc;
                        }, {}),
                        places: list.map(p => p.name)
                    })
                );
            };



            window.selectPlace = function (idx) {
                const p = lastPlaces[idx];
                if (!p) {
                    return;
                }
                const pos = new kakao.maps.LatLng(p.lat, p.lng);
                const m = new kakao.maps.Marker({ position: pos, map });
                markers.push(m);

                const content = p.info && p.info.total
                    ? `<div class="parking-label"><strong>${p.name}</strong>${Math.max(p.info.free, 0)}/${p.info.total}</div>`
                    : `<div class="marker-label">${p.name}</div>`;

                const ov = new kakao.maps.CustomOverlay({
                    map, position: pos, content,
                    yAnchor: 1, offset: new kakao.maps.Size(0, 15)
                });
                overlays.push(ov);
                map.setCenter(pos);
                map.setLevel(3);
            };

            window.selectPlaceByName = function (name) {
                const p = lastPlaces.find(pl => pl.name === name);
                if (!p) return;
                const pos = new kakao.maps.LatLng(p.lat, p.lng);
                const m = new kakao.maps.Marker({ position: pos, map });
                markers.push(m);

                const content = p.info && p.info.total
                    ? `<div class="parking-label"><strong>${p.name}</strong>${Math.max(p.info.free, 0)}/${p.info.total}</div>`
                    : `<div class="marker-label">${p.name}</div>`;

                const ov = new kakao.maps.CustomOverlay({
                    map, position: pos, content,
                    yAnchor: 1, offset: new kakao.maps.Size(0, 15)
                });
                overlays.push(ov);
                map.setCenter(pos);
                map.setLevel(3);
            };

            window.clearMarkers = function () {
                markers.forEach(m => m.setMap(null));
                overlays.forEach(o => o.setMap(null));
                parkingMarkers.forEach(m => m.setMap(null));
                parkingOverlays.forEach(o => o.setMap(null));

                markers = [];
                overlays = [];
                parkingMarkers = [];
                parkingOverlays = [];
            };

            function handleMessage(e) {
                let msg;
                try { msg = JSON.parse(e.data) } catch { return }
                if (msg.keyword) window.searchPlaces(msg.keyword);
                else if (msg.type === 'PARKING') window.searchParking();
                else if (msg.index !== undefined) window.selectPlace(msg.index);
                else if (msg.type === 'CLEAR_MARKERS') window.clearMarkers();
            }
            window.addEventListener('message', handleMessage);
            document.addEventListener('message', handleMessage);

        });
    </script>
</body>

</html>