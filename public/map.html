<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script
        src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=d73e9b362b7e9d719a4bf602da77dcb4&libraries=services&autoload=false"></script>
    <style>
        html,
        body,
        #map {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
        }

        .marker-label {
            position: relative;
            left: 50%;
            top: 20px;
            transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.8);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            color: #333;
            white-space: nowrap;
            pointer-events: none;
        }
    </style>
</head>

<body>
    <div id="map"></div>
    <script>
        kakao.maps.load(function () {
            const map = new kakao.maps.Map(
                document.getElementById('map'),
                { center: new kakao.maps.LatLng(37.55893664, 126.9987376), level: 3 }
            );
            const places = new kakao.maps.services.Places(map);

            window.markers = [];
            window.overlays = [];
            window.lastPlacesData = [];

            function clearMarkers() {
                window.markers.forEach(m => m.setMap(null));
                window.markers = [];
            }
            function clearOverlays() {
                window.overlays.forEach(o => o.setMap(null));
                window.overlays = [];
            }

            window.searchPlaces = function (keyword) {
                if (!keyword) return;
                const center = map.getCenter();
                clearMarkers(); clearOverlays();
                places.keywordSearch(keyword, (data, status) => {
                    if (status === kakao.maps.services.Status.OK && data.length) {
                        window.lastPlacesData = data;
                        data.forEach((p, i) => {
                            const loc = new kakao.maps.LatLng(p.y, p.x);
                            const marker = new kakao.maps.Marker({ position: loc, map });
                            window.markers.push(marker);
                            const overlay = new kakao.maps.CustomOverlay({
                                map, position: loc,
                                content: `<div class="marker-label">${p.place_name}</div>`,
                                yAnchor: 1
                            });
                            window.overlays.push(overlay);
                            kakao.maps.event.addListener(marker, 'click', () => {
                                window.ReactNativeWebView.postMessage(
                                    JSON.stringify({ type: 'MARKER_CLICK', index: i })
                                );
                            });
                        });
                        map.setCenter(center);
                        window.ReactNativeWebView.postMessage(
                            JSON.stringify({ type: 'PLACES_LIST', places: data.map(p => p.place_name) })
                        );
                    } else {
                    }
                }, { location: center, radius: 500 });
            };

            window.selectPlace = function (idx) {
                clearMarkers(); clearOverlays();
                const p = window.lastPlacesData[idx];
                if (!p) return;
                window.lastPlacesData = [p];
                const loc = new kakao.maps.LatLng(p.y, p.x);
                const marker = new kakao.maps.Marker({ position: loc, map });
                window.markers.push(marker);
                const overlay = new kakao.maps.CustomOverlay({
                    map, position: loc,
                    content: `<div class="marker-label">${p.place_name}</div>`,
                    yAnchor: 1
                });
                window.overlays.push(overlay);
                map.setCenter(loc);
                map.setLevel(4);
            };

            function handleMessage(e) {
                let msg;
                try { msg = JSON.parse(e.data); } catch { return; }
                if (msg.keyword) window.searchPlaces(msg.keyword);
                else if (msg.index !== undefined) window.selectPlace(msg.index);
            }
            window.addEventListener('message', handleMessage);
            document.addEventListener('message', handleMessage);
        });
    </script>
</body>

</html>